version: 2.1

workflows:
  test-env-vars:
    jobs:
      - create-init-arm64-archlinux-image:
          context: github
          
jobs:
  create-init-arm64-archliunx-image:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium
    working_directory: ~/project
    steps:
      - run:
          name: Get arm archlinux rootfs
          command: |
            mkdir rootfs
            curl https://os.archlinuxarm.org/os/ArchLinuxArm-aarch64-latest.tar.gz -o archlinux.tar.gz
            tar xvzf archlinux.tar.gz -C rootfs
            tar cf archlinux.tar -C rootfs .
            docker import archlinux.tar henryhwang/archlinuxarm64:latest
      - store_artifacts:
          path: ~/project/archlinux.tar
          destination: archlinux-arm64.tar

    
  build:
    machine:
      image: ubuntu-2004:current
    resource_class: arm.medium
    working_directory: ~/project
    steps:
      - run:
          name: Get Source Code
          command: git clone https://github.com/neovim/neovim ~/project
      - run:
          name: APT update
          command: sudo apt-get update
      - run:
          name: Install dependencies
          command: sudo apt-get install -y ninja-build gettext libtool libtool-bin autoconf automake cmake g++ pkg-config unzip curl doxygen
      - run:
          name: build
          command: |
            make CMAKE_BUILD_TYPE=Release CMAKE_EXTRA_FLAGS="-DCMAKE_INSTALL_PREFIX:PATH="
            make DESTDIR="./build/release/nvim-arm64" install
            cd ./build
            cpack -C Release -D CPACK_PACKAGE_FILE_NAME="nvim-arm64"
            ls -l
      - store_artifacts:
          path: ~/project/build/nvim-arm64.tar.gz
          destination: nvim-arm64.tar.gz
      - store_artifacts:
          path: ~/project/build/nvim-arm64.deb
          destination: nvim-arm64.deb
      - run:
          name: make a release on github
          command: |
            cd ~/project
            mkdir githubrelease
            cp ./build/nvim-arm64.tar.gz ./githubrelease/nvim-arm64.tar.gz
            cp ./build/nvim-arm64.deb ./githubrelease/nvim-arm64.deb
            go install github.com/tcnksm/ghr@latest
            VERSION=0.8.0
            ls -l ./githubrelease/
            echo "-t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -delete ${VERSION} ./githubrelease/"
            ghr -t ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -delete 0.8.0 ./githubrelease/
